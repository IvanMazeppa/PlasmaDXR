#!/usr/bin/env python3
"""
GPT-5.2 â€” Test Fireball (OpenVDB) - Blender 5.0+

Generated by PlasmaDXR Script Generator
Date: 2025-12-25
Template: built-in explosion

Description:
    bright orange fireball explosion with rising smoke and ember particles

Usage:
    blender --background --python test_fireball.py -- [options]

Options:
    --resolution INT    Simulation resolution (default: 64)
    --frame_start INT   Start frame (default: 1)
    --frame_end INT     End frame (default: 40)
    --output_dir PATH   Output directory for VDB files
    --bake BOOL         Run bake (1) or skip (0)
"""

import bpy
import sys
import os
from pathlib import Path

# =============================================================================
# Configuration
# =============================================================================

class Config:
    """Script configuration - modify these values or pass via command line."""

    RESOLUTION = 64
    FRAME_START = 1
    FRAME_END = 40
    OUTPUT_DIR = "/home/maz3ppa/projects/PlasmaDXR/build/vdb_output/test_fireball"
    BAKE = True

    # Domain settings
    DOMAIN_SCALE = 4.0

    # Simulation settings
    # Effect: explosion
    # bright orange fireball explosion with rising smoke...


def parse_args():
    """Parse command line arguments after '--'."""
    argv = sys.argv
    if "--" in argv:
        argv = argv[argv.index("--") + 1:]
    else:
        argv = []

    i = 0
    while i < len(argv):
        arg = argv[i]
        if arg == "--resolution" and i + 1 < len(argv):
            Config.RESOLUTION = int(argv[i + 1])
            i += 2
        elif arg == "--frame_start" and i + 1 < len(argv):
            Config.FRAME_START = int(argv[i + 1])
            i += 2
        elif arg == "--frame_end" and i + 1 < len(argv):
            Config.FRAME_END = int(argv[i + 1])
            i += 2
        elif arg == "--output_dir" and i + 1 < len(argv):
            Config.OUTPUT_DIR = argv[i + 1]
            i += 2
        elif arg == "--bake" and i + 1 < len(argv):
            Config.BAKE = argv[i + 1].lower() in ("1", "true", "yes")
            i += 2
        else:
            i += 1

parse_args()

# =============================================================================
# Scene Setup
# =============================================================================

def clear_scene():
    """Remove all objects from scene."""
    bpy.ops.object.select_all(action='SELECT')
    bpy.ops.object.delete()

def setup_scene():
    """Configure scene settings."""
    scene = bpy.context.scene
    scene.frame_start = Config.FRAME_START
    scene.frame_end = Config.FRAME_END
    scene.render.engine = 'CYCLES'
    scene.cycles.device = 'GPU'


# =============================================================================
# Domain Creation
# =============================================================================

def create_domain():
    """Create and configure fluid domain for explosion."""
    # Create domain cube
    bpy.ops.mesh.primitive_cube_add(size=Config.DOMAIN_SCALE, location=(0, 0, 0))
    domain = bpy.context.active_object
    domain.name = "FluidDomain"

    # Add fluid modifier
    bpy.ops.object.modifier_add(type='FLUID')
    domain.modifiers["Fluid"].fluid_type = 'DOMAIN'

    settings = domain.modifiers["Fluid"].domain_settings
    settings.domain_type = 'GAS'

    # Resolution
    settings.resolution_max = Config.RESOLUTION
    settings.use_adaptive_domain = True

    # Cache settings
    settings.cache_type = 'ALL'
    settings.cache_directory = Config.OUTPUT_DIR
    settings.cache_data_format = 'OPENVDB'

    # Gas behavior
    settings.burning_rate = 0.75
    settings.flame_smoke = 0.5
    settings.flame_vorticity = 0.5
    settings.flame_max_temp = 3.0

    # Add volumetric material to domain
    mat = bpy.data.materials.new(name="VolumeMaterial")
    mat.use_nodes = True
    nodes = mat.node_tree.nodes
    links = mat.node_tree.links
    
    # Clear default nodes
    nodes.clear()
    
    # Add Principled Volume
    volume_node = nodes.new('ShaderNodeVolumePrincipled')
    volume_node.location = (0, 0)
    volume_node.inputs['Color'].default_value = (1.0, 0.4, 0.1, 1.0)  # Orange
    volume_node.inputs['Density'].default_value = 5.0
    volume_node.inputs['Blackbody Intensity'].default_value = 1.0
    volume_node.inputs['Temperature'].default_value = 1500.0
    
    # Add output
    output_node = nodes.new('ShaderNodeOutputMaterial')
    output_node.location = (300, 0)
    
    # Connect volume to output
    links.new(volume_node.outputs['Volume'], output_node.inputs['Volume'])
    
    # Assign material to domain
    domain.data.materials.append(mat)
    
    return domain


def create_emitter():
    """Create flow emitter for explosion."""
    # Create emitter geometry
    bpy.ops.mesh.primitive_uv_sphere_add(radius=0.5, location=(0, 0, 0))

    emitter = bpy.context.active_object
    emitter.name = "FlowEmitter"

    # Add fluid modifier as flow
    bpy.ops.object.modifier_add(type='FLUID')
    emitter.modifiers["Fluid"].fluid_type = 'FLOW'

    flow = emitter.modifiers["Fluid"].flow_settings
    flow.flow_type = 'SMOKE'  # or 'FIRE', 'BOTH'
    flow.flow_behavior = 'INFLOW'
    flow.flow_type = 'BOTH'  # Fire and smoke
    flow.fuel_amount = 1.0
    flow.temperature = 2.0

    return emitter


# =============================================================================
# Baking & Export
# =============================================================================

def bake_simulation(domain):
    """Bake the fluid simulation."""
    print(f"[script] Baking simulation: frames {Config.FRAME_START}-{Config.FRAME_END}")
    print(f"[script] Resolution: {Config.RESOLUTION}")
    print(f"[script] Output: {Config.OUTPUT_DIR}")

    # Ensure output directory exists
    Path(Config.OUTPUT_DIR).mkdir(parents=True, exist_ok=True)

    # Select domain and bake
    bpy.context.view_layer.objects.active = domain
    domain.select_set(True)

    bpy.ops.fluid.bake_all()

    print("[script] Bake complete!")


# =============================================================================
# Main
# =============================================================================

def main():
    print("=" * 60)
    print("Test Fireball")
    print("=" * 60)

    clear_scene()
    setup_scene()

    domain = create_domain()
    emitter = create_emitter()

    if Config.BAKE:
        bake_simulation(domain)
    else:
        print("[script] Skipping bake (--bake 0)")

    # Save blend file
    blend_path = Path(Config.OUTPUT_DIR) / "test_fireball.blend"
    bpy.ops.wm.save_as_mainfile(filepath=str(blend_path))
    print(f"[script] Saved: {blend_path}")


if __name__ == "__main__":
    main()
